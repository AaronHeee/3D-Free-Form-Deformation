# 数据可视化期末项目

---

**姓名：** 王艺楷、冉诗菡、何占魁

**学号：** 15300180076、15307130424、15307130175

---



## 任务：FFD三维形变平台 

>1. 基于VTK或其他显示库开发一个具有GUI功能的工具，用于实现3D Free-Form Deformation (FFD)的可视化和交互。要求可以人工设置调节每个控制点的位移，可以读入FFD文件(找吴富平助教拿zxhproj的.FFD文件格式)设置位移，输出FFD(.FFD格式);同时可视化形变场，如使用网格线和surface model(vtk polydata格式)。 
>2. 作业以小组形式:每个小组3个人。提交作业时只要一个代表提交就可以。记住:不要多人重复提交。 
>3. 提交内容包括: 
>   - 报告:在报告中清晰描述问题和数据，数据处理的各个步骤及中间结果，代码结构，开发环境，可执行文件使用手册等细节问题。 
>   - 代码:使用Python(Matlab或C/C++)开发;代码要有非常清晰的注释。 
>   - 提交可执行文件 
>   - 测试数据 
>   - 鼓励用视频解释可视化操作过程与展示结果 
>4. 截止时间
>   - 6月24日23:00 (16周结束)
>   - 7月22日23:00 (20周结束，难度和完成分:(A/10)^2) 

#### 一、问题和数据：

1. ##### 问题描述：

   

2. ##### 数据描述：




#### 二、数据处理：

1. ##### 算法描述：

   ###### 3D Face Reconstruction

   

   ###### 3D Free-Form Deformation (FFD)

   FFD的主要目的是通过对全局形变函数和局部形变函数的构造达到对非刚性形变的模拟。即将形变函数:
   $$
   \textbf{T}:(x,y,z)\rightarrow (x^{'},y^{'},z^{'})
   $$
   构造为为全局形变函数和局部形变函数的组合：
   $$
   \textbf{T}(x,y,z)=\textbf{T}_{global}(x,y,z)+\textbf{T}_{local}(x,y,z)
   $$
   其中，全局性变函数是一个自由变换(affine transformation).定义为：
   $$
   \textbf{T}_{global}(x,y,z)=\left(\begin{matrix}\theta_{11}&\theta_{12}&\theta_{13}\\\theta_{21}&\theta_{22}&\theta_{23}\\\theta_{31}&\theta_{32}&\theta_{33}\end{matrix}\right)\left(\begin{matrix}x\\y\\z\end{matrix}\right)+\left(\begin{matrix}\theta_{14}\\\theta_{24}\\\theta_{34}\end{matrix}\right)
   $$
   为了定义基于样条函数的局部形变FFD，我们定义物体所占据的区域为$\Omega=\{(x,y,z)|0\leq x<X,0\leq y <Y,0\leq z<Z\}$.定义$\Phi$为体积为$n_x*n_y*n_z$的控制点网络，其中$n_i$为第i个维度相邻控制点之间的距离。那么FFD可以被定义为一维立方B样条的三维张量积：
   $$
   \textbf{T}_{local}(x,y,z)=\sum_{l=0}^3\sum_{m=0}^3\sum_{n=0}^3B_t(u)B_m(v)B_n(w)\phi_{i+l,j+m,k+n}
   $$
   其中$i=\lfloor x/n_x\rfloor-1,j=\lfloor y/n_y\rfloor-1,k=\lfloor z/n_z\rfloor-1,\\u=x/n_x-\lfloor x/n_x\rfloor,v=y/n_y-\lfloor y/n_y\rfloor,w=z/n_z-\lfloor z/n_z\rfloor$

   样条函数的定义如下:
   $$
   B_0(u)=\frac{(1-u)^3}{6}\\
   B_1(u)=\frac{3u^3-6u^2+4}{6}\\
   B_2(u)=\frac{-3u^3+3u^2+3u+1}{6}\\
   B_1(u)=\frac{u^3}{6}
   $$
   

   ###### Control Framework

   - **控制点生成**
     - 确定控制点位置和数量：首先需要根据读入文件的坐标位置确定控制点的位置，我们在目标物体的周围生成$n\times n\times n$的立方体，使得该立方体恰好“包裹”住目标物体。
     - 生成球体：在每一个控制点的位置利用`vtk.vtkSphereWidget()`生成一个球体，配置球体半径、颜色等属性。
   - **控制点间邻居结点连线生成**
     - 计算邻居结点：对于每一个控制点球体，计算以它为中心的前后上下左右的六个邻居结点的位置。
     - 邻居结点连线：将每个控制点与他们所对应的邻居结点用`vtk.vtkLineSource()`连接起来。
   - **设置控制点监听器**
     - 对于每一个控制点，利用`AddObserver`监听`vtkRenderWindowInteractor`里的事件。
   - **进行交互**
     - 我们定义回调函数`sphereCallback`来实现交互。
     - 在该回调函数中，会对每个控制点球体的位置进行查询，如果球体位置发生更新，则重新生成该球体与邻居结点的连线，并把该球体的新位置返回给FFD算法进行计算形变。
     - 获取FFD算法计算好后的数据，用`RemoveActor`去除之前显示的物体并用`AddActor`显示更新形变后的物体。

   ###### GUI

   

2. ##### 图像处理：

   ###### 利用照片重建3D人脸

   

   ###### Obj文件读入和纹理着色

   

   ###### 控制点位置确定

   

3. ##### 变形结果：

     

4. ##### 结果分析:



​

#### 三、代码结构：

1. ##### 结构简述：

   

2. ##### 函数详述：

   1. ##### 辅助函数：

      **辅助函数**即实现算法的工具函数，是对算法描述中出现的映射关系的代码化，同时具有模块性，可以进行替换调整，以探究不同的效果，该代码中有：

   2. ##### 核心函数：

      **核心函数**是实现算法的主要函数，接口暴露给用户直接调用，不具有模块性。该代码中包含：

   

#### 四、开发环境：
-  **系统环境：**macOS High Serria
-  **开发语言：**Python>=3.5
-  **软件包：**Numpy>=1.13.0,  vtk




#### 五、可执行文件使用： 

-  **使用环境：**macOS

-  **文件名称**：

-  **使用方式：**

-  **补充说明：**



#### 六、一些尝试：

#### 

#### 七、合作者贡献：

-  **王艺楷：**FFD算法实现，报告撰写

-  **冉诗菡：**控制点算法及交互实现，报告撰写

-  **何占魁：** GUI实现，报告撰写

   ​


